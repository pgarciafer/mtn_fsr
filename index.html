<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Field Service Report</title>

  <style>
    :root{
      --accent:#0b68b0;
      --muted:#666;
      --paper-width:210mm;
    }
    body{
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      margin:12px;
      background: #f4f6f8;
      color:#222;
    }
    .sheet {
      background: white;
      width: calc(var(--paper-width) - 24px);
      margin: 10px auto;
      padding: 18mm;
      border-radius: 6px;
      box-shadow: 0 4px 18px rgba(0,0,0,0.06);
      box-sizing: border-box;
    }
    header h1{ margin:0; color:var(--accent); font-size:20px; }
    header .meta{ color:var(--muted); font-size:13px; margin-top:6px;}
    .section{ margin-top:16px; padding-top:12px; }
    .row{ display:flex; gap:12px; margin-bottom:8px; flex-wrap:wrap; }
    .col{ flex:1; min-width:180px; }
    label{ display:block; font-size:12px; color:#333; margin-bottom:4px; }
    input[type="text"], input[type="date"], input[type="number"], textarea{
      width:100%; box-sizing:border-box; padding:8px;
      border:1px solid #d7dbe1; border-radius:4px; font-size:13px; background:#fff;
    }
    textarea{ min-height:80px; resize:vertical; }
    .table-like{ border:1px solid #e0e4ea; padding:10px; border-radius:6px; background:#fbfdff; }
    .controls{ display:flex; gap:8px; margin-top:12px; flex-wrap:wrap;}
    button{
      background:var(--accent); color:white; border:none; padding:10px 14px; border-radius:6px;
      cursor:pointer; font-weight:600; box-shadow: 0 4px 8px rgba(11,104,176,0.12);
    }
    button.secondary{ background:#f3f5f8; color:#222; box-shadow:none; border:1px solid #e1e5ea; }
    .signature-box{ min-height:64px; border:1px dashed #cfd6dd; padding:8px; border-radius:4px; background:#fff; }
    .rating{ display:flex; gap:6px; align-items:center; }
    .rating input{ width:40px; }

    .pdf-mode .sheet {
      width: calc(var(--paper-width) - 24px) !important;
      padding: 18mm !important;
      margin: 10px auto !important;
      border-radius: 6px !important;
    }

    @media print{
      body{ background:white; margin:0; }
      .sheet{ box-shadow:none; margin:0; padding:8mm; }
      button, .controls{ display:none; }
    }
    
    @media screen and (max-width: 768px) {
      .sheet {
        width: 100% !important;
        padding: 12px;
        margin: 0;
        border-radius: 0;
      }
      .row { flex-direction: column; gap: 8px; }
      .col { min-width: 100% !important; }
      header h1 { font-size: 16px; }
      header .meta { font-size: 12px; }
    }

    @media print {
      .section { page-break-inside: avoid; }
    }

    .reportCard { page-break-inside: avoid; margin-bottom: 12px; }

    .pdf-export .reportCard textarea {
      display: block;
      width: 100%;
      min-height: 80px;
      max-height: 200px;
      overflow: hidden;
      border: 1px solid #ccc;
      padding: 6px;
      resize: none;
      box-sizing: border-box;
      font-family: inherit;
      font-size: 12px;
      white-space: pre-wrap;
    }
    .reportTextBox {
      border: 1px solid #ccc;
      padding: 6px;
      min-height: 80px;
      overflow: hidden;
      box-sizing: border-box;
      font-family: inherit;
      font-size: 12px;
      background: #fafafa;
      border-radius: 4px;
      white-space: pre-wrap;
    }
    .report-header {
      display: flex;
      align-items: center;
      gap: 16px;
      border-bottom: 2px solid #e0e4ea;
      padding-bottom: 12px;
      margin-bottom: 18px;
    }
    .report-header .logo { height: 64px; width: auto; }
    .header-text h1 { margin: 0; color: var(--accent); font-size: 24px; }
    .header-text .meta { color: var(--muted); font-size: 15px; margin-top: 4px; }
    .report-header .logo-link { display: inline-block; }
    .pdf-mode .report-header { border-bottom: 1px solid #ccc; }
    button.add-button {
  background: #4CAF50; /* A nice shade of green */
  box-shadow: 0 4px 8px rgba(76, 175, 80, 0.12); /* Optional: Adjust shadow color */
}

button.remove-button {
  background: #f44336; /* A nice shade of red */
  color: white; /* Make the text white for better contrast */
  box-shadow: 0 4px 8px rgba(244, 67, 54, 0.12); /* Optional: Adjust shadow color */
  border: none; /* Remove the border inherited from .secondary */
}
  </style>
</head>
<body>
  <div class="sheet" id="reportRoot">
    <header class="report-header">
      <a href="https://mtnsat.com" target="_blank" class="logo-link">
        <img src="https://raw.githubusercontent.com/pgarciafer/mtn_fsr/main/mtnsatlogo.png" 
             alt="MNT Sat Logo" class="logo">
      </a>
      <div class="header-text">
        <h1>Field Service Report</h1>
        <div class="meta">Field Services Engineering Document</div>
      </div>
    </header>

    <!-- Submitted By -->
    <div class="section table-like">
      <div class="row">
        <div class="col"><label>Submitted By</label><input type="text" id="submittedBy" /></div>
        <div class="col"><label>Position</label><input type="text" id="position" /></div>
        <div class="col"><label>Date</label><input type="date" id="formDate" /></div>
      </div>
    </div>

    <!-- Case Details -->
    <div class="section">
      <h3>Case Details</h3>
      <div class="row table-like">
        <div class="col"><label>Case Number</label><input type="text" id="woNumber" /></div>
        <div class="col"><label>Description</label><input type="text" id="taskDescription" /></div>
        <div class="col"><label>Additional Technician Names</label><input type="text" id="techNames" /></div>
        <div class="col"><label>Customer</label><input type="text" id="customer" /></div>
        <div class="col"><label>Site Name</label><input type="text" id="siteName" /></div>
        <div class="row table-like">
          <div class="col"><label>Arrival Location / Date</label><input type="text" id="arrival" /></div>
          <div class="col"><label>Departure Location / Date</label><input type="text" id="departure" /></div>
        </div>
      </div>
    </div>

    <!-- Assets (moved inside .sheet) -->
    <div class="section">
      <h3>Assets</h3>
      <div id="assetsContainer"></div>
      <div class="controls">
    <button type="button" id="addAsset" class="add-button">Add Asset</button>
    <button type="button" id="removeAsset" class="remove-button secondary">Remove Last Asset</button>
</div>
    </div>

    <!-- Report Entries -->
    <div class="section">
      <h3>Report & Additional Details</h3>
      <div id="reportEntries">
        <div class="table-like" style="margin-bottom:8px;">
          <div class="row" style="flex-direction:column;">
            <div class="col" style="width:100%;"><label>Date</label><input type="date" class="entryDate" /></div>
            <div class="col" style="width:100%;"><label>Report Detail</label><textarea class="entryDetail"></textarea></div>
          </div>
        </div>
      </div>
      <div class="controls">
        <button type="button" id="addEntry">Add Report Entry</button>
        <button type="button" id="removeEntry" class="secondary">Remove Last Entry</button>
      </div>
    </div>

    <!-- Embedded Files -->
    <div class="section">
      <h3>Embedded Files / Configs</h3>
      <div id="embeddedContainer">
        <div class="embeddedCard row table-like" style="margin-bottom:10px;">
          <div class="col"><label>Description</label><input type="text" class="embDesc" /></div>
          <div class="col"><label>Files</label><input type="text" class="embFiles" /></div>
        </div>
      </div>
      <div class="controls">
        <button type="button" id="addEmbedded">Add Embedded File</button>
        <button type="button" id="removeEmbedded" class="secondary">Remove Embedded File</button>
      </div>
    </div>

    <!-- Final Comments -->
    <div class="section">
      <h3>Final Comments / Recommendations</h3>
      <textarea id="finalComments"></textarea>
      <div style="display:flex; gap:12px; margin-top:12px; flex-wrap:wrap;">
        <div style="flex:1; min-width:220px;">
          <label>Technician Name</label><input type="text" id="techName" />
          <label style="margin-top:6px">Signature</label>
          <div class="signature-box">[Signature area]</div>
          <label style="margin-top:6px">Date</label><input type="date" id="techDate" />
        </div>
        <div style="flex:1; min-width:220px;">
          <label>Customer Representative Name & Position</label><input type="text" id="custName" />
          <label style="margin-top:6px">Signature</label>
          <div class="signature-box">[Signature area]</div>
          <label style="margin-top:6px">Date</label><input type="date" id="custDate" />
        </div>
      </div>
    </div>

    <!-- Customer Feedback -->
    <div class="section">
      <h3>Customer Feedback</h3>
      <div class="row">
        <div class="col">
          <label>Rate our field work (1–10)</label>
          <div class="rating"><input type="number" min="1" max="10" id="rating" /></div>
        </div>
        <div class="col"><label>Comments</label><textarea id="custComments"></textarea></div>
      </div>
    </div>

        <!-- Controls -->
    <div class="controls" style="margin-top:18px;">
      <button id="generatePdf">Generate PDF</button>
      <button id="printBtn" class="secondary">Print (Save PDF)</button>
      <button id="downloadJson" class="secondary">Download JSON</button>
      <button id="clearForm" class="secondary">Clear form</button>
    </div>

    
  </div> <!-- now close .sheet here -->



  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
  <script>
    function cloneCard(containerId, cardClass){
      const container = document.getElementById(containerId);
      const firstCard = container.querySelector(`.${cardClass}`);
      const clone = firstCard.cloneNode(true);
      clone.querySelectorAll('input, textarea').forEach(el => el.value = '');
      container.appendChild(clone);
    }
    function removeCard(containerId){
      const container = document.getElementById(containerId);
      if(container.children.length > 1) container.removeChild(container.lastElementChild);
    }

    // Embedded Files
    document.getElementById('addEmbedded').onclick = ()=>cloneCard('embeddedContainer','embeddedCard');
    document.getElementById('removeEmbedded').onclick = ()=>removeCard('embeddedContainer');

    // Report Entries
    document.getElementById('addEntry').onclick = ()=>{
      const container = document.getElementById('reportEntries');
      const block = document.createElement('div');
      block.className = 'table-like';
      block.style.marginBottom = '8px';
      block.innerHTML = `
        <div class="row" style="flex-direction:column;">
          <div class="col" style="width:100%;"><label>Date</label><input type="date" class="entryDate" /></div>
          <div class="col" style="width:100%;"><label>Report Detail</label><textarea class="entryDetail"></textarea></div>
        </div>`;
      container.appendChild(block);
    };
    document.getElementById('removeEntry').onclick = ()=>{
      const container = document.getElementById('reportEntries');
      if(container.children.length > 1) container.removeChild(container.lastElementChild);
    };

    // Clear form
    document.getElementById('clearForm').onclick = ()=>{
      if(!confirm('Clear all fields?')) return;
      document.querySelectorAll('#reportRoot input, #reportRoot textarea').forEach(el => el.value = '');
      document.getElementById('embeddedContainer').innerHTML = document.querySelector('.embeddedCard').outerHTML;
      document.getElementById('reportEntries').innerHTML = `
        <div class="table-like" style="margin-bottom:8px;">
          <div class="row" style="flex-direction:column;">
            <div class="col" style="width:100%;"><label>Date</label><input type="date" class="entryDate" /></div>
            <div class="col" style="width:100%;"><label>Report Detail</label><textarea class="entryDetail"></textarea></div>
          </div>
        </div>`;
    };

    // Gather form data
        function gatherFormData() {
      function get(id) {
        return document.getElementById(id)?.value || "";
      }

      // Report entries
      const entries = Array.from(document.querySelectorAll('#reportEntries .reportEntry')).map(entry => ({
        date: entry.querySelector('.reportDate').value,
        location: entry.querySelector('.reportLocation').value,
        description: entry.querySelector('.reportDescription').value
      }));

      // Embedded images
      const embedded = Array.from(document.querySelectorAll('#imagePreview img')).map(img => img.src);

      // Assets
      const assets = Array.from(document.querySelectorAll('#assetsContainer .assetCard')).map(card => ({
        type: card.querySelector('input[readonly]').value,
        detail: card.querySelector('.assetDetail').value
      }));

      // Final return
      return {
        submittedBy: get('submittedBy'),
        position: get('position'),
        formDate: get('formDate'),
        dispatch: {
          woNumber: get('woNumber'),
          taskDescription: get('taskDescription'),
          customer: get('customer'),
          techNames: get('techNames'),
          siteName: get('siteName'),
          arrival: get('arrival'),
          departure: get('departure')
        },
        assets,  // ✅ added here
        reportEntries: entries,
        embedded,
        finalComments: get('finalComments'),
        signatures: {
          techName: get('techName'),
          techDate: get('techDate'),
          custName: get('custName'),
          custDate: get('custDate')
        },
        feedback: {
          rating: get('rating'),
          comments: get('custComments')
        }
      };
    }


    // JSON export
    document.getElementById('downloadJson').onclick = ()=>{
      const data = gatherFormData();
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='field_service_report.json'; a.click();
      URL.revokeObjectURL(url);
    };

    // PDF
    document.getElementById('generatePdf').onclick = () => {
      const now = new Date();
      const fname = `FieldServiceReport_${now.toISOString().split('T')[0]}.pdf`;
      const element = document.getElementById('reportRoot');
      document.body.classList.add("pdf-mode");

      document.querySelectorAll('#reportEntries .table-like textarea').forEach(textarea => {
        const div = document.createElement('div');
        div.className = 'reportTextBox';
        div.textContent = textarea.value;
        div.style.minHeight = textarea.scrollHeight + "px";
        textarea.style.display = 'none';
        textarea.parentNode.insertBefore(div, textarea);
      });
      element.classList.add("pdf-export");

      html2pdf().set({
        margin:[8,8,8,8],
        filename:fname,
        image:{ type:'jpeg', quality:0.98 },
        html2canvas:{ scale:2, useCORS:true, logging:false },
        jsPDF:{ unit:'mm', format:'a4', orientation:'portrait' }
      }).from(element).toPdf().get('pdf').then(pdf => {
        pdf.link(20, 20, 40, 15, { url: "https://mtnsat.com" });
      }).save().then(()=>{
        document.querySelectorAll('#reportEntries .reportTextBox').forEach(div => div.remove());
        document.querySelectorAll('#reportEntries textarea').forEach(textarea => textarea.style.display = '');
        element.classList.remove("pdf-export");
        document.body.classList.remove("pdf-mode");
      });
    };

        // Assets
    // Assets
document.getElementById('addAsset').onclick = () => {
    const validAssets = ["VSAT", "TVRO", "Starlink", "5G", "Other"];
    const container = document.getElementById('assetsContainer');
    const controls = document.querySelector('.controls');

    // Create a temporary dropdown element
    const tempSelectDiv = document.createElement('div');
    tempSelectDiv.className = 'temp-select-container';
    tempSelectDiv.innerHTML = `
        <label>Select Asset Type:</label>
        <select id="assetSelect" style="padding: 8px; border: 1px solid #d7dbe1; border-radius: 4px; font-size: 13px;">
            <option value="">-- Please Choose --</option>
            ${validAssets.map(asset => `<option value="${asset}">${asset}</option>`).join('')}
        </select>
        <button id="confirmAsset" type="button" class="add-button" style="margin-left: 8px;">OK</button>
        <button id="cancelAsset" type="button" class="secondary">Cancel</button>
    `;

    // Insert the dropdown before the asset controls
    controls.parentNode.insertBefore(tempSelectDiv, controls);

    const assetSelect = document.getElementById('assetSelect');
    const confirmButton = document.getElementById('confirmAsset');
    const cancelButton = document.getElementById('cancelAsset');

    confirmButton.onclick = () => {
        const assetType = assetSelect.value;
        if (!assetType) {
            alert("Please select an asset type.");
            return;
        }
        
        // Remove the temporary dropdown
        tempSelectDiv.remove();

        // Create the new asset card
        const block = document.createElement('div');
        block.className = 'assetCard table-like';
        block.style.marginBottom = '8px';
        block.innerHTML = `
            <div class="row">
                <div class="col"><label>Asset Type</label><input type="text" value="${assetType}" readonly /></div>
                <div class="col"><label>Details</label><input type="text" class="assetDetail" /></div>
            </div>`;
        container.appendChild(block);
    };

    cancelButton.onclick = () => {
        tempSelectDiv.remove();
    };
};

    document.getElementById('removeAsset').onclick = () => {
      const container = document.getElementById('assetsContainer');
      if (container.children.length > 0) container.removeChild(container.lastElementChild);
    };


    // Print
    document.getElementById('printBtn').onclick = ()=>window.print();
  </script>
</body>
</html>
